From a3e72a90c008d64d320dbcb9a58b12e1fb017aff Mon Sep 17 00:00:00 2001
From: Marco Chini <chnmrc@mchini.com>
Date: Sat, 19 May 2018 20:47:05 +0200
Subject: [PATCH 1/4] https://bugs.swift.org/browse/SR-6812

---
 CoreFoundation/Base.subproj/CFRuntime.h  | 8 ++++++++
 CoreFoundation/String.subproj/CFString.h | 4 ++++
 2 files changed, 12 insertions(+)

diff --git a/CoreFoundation/Base.subproj/CFRuntime.h b/CoreFoundation/Base.subproj/CFRuntime.h
index 84a05650..94351c4e 100644
--- a/CoreFoundation/Base.subproj/CFRuntime.h
+++ b/CoreFoundation/Base.subproj/CFRuntime.h
@@ -195,10 +195,18 @@ typedef struct __CFRuntimeBase {
     uintptr_t _cfisa;
     uintptr_t _swift_rc;
     // This is for CF's use, and must match _NSCFType layout
+#if __LP64__
     _Atomic(uint64_t) _cfinfoa;
+#else
+    _Atomic(uint32_t) _cfinfoa;
+#endif
 } CFRuntimeBase;
 
+#if __LP64__
 #define INIT_CFRUNTIME_BASE(...) {0, _CF_CONSTANT_OBJECT_STRONG_RC, 0x0000000000000080ULL}
+#else
+#define INIT_CFRUNTIME_BASE(...) {0, _CF_CONSTANT_OBJECT_STRONG_RC, 0x00000080UL}
+#endif
 
 #else
 
diff --git a/CoreFoundation/String.subproj/CFString.h b/CoreFoundation/String.subproj/CFString.h
index d818f2ae..4e54c40b 100644
--- a/CoreFoundation/String.subproj/CFString.h
+++ b/CoreFoundation/String.subproj/CFString.h
@@ -156,7 +156,11 @@ struct __CFConstStr {
     struct {
         uintptr_t _cfisa;
         uintptr_t _swift_rc;
+#if defined(__LP64__)
         uint64_t _cfinfoa;
+#else
+        uint32_t _cfinfoa;
+#endif
     } _base;
     uint8_t *_ptr;
 #if defined(__LP64__) && defined(__BIG_ENDIAN__)
-- 
2.17.1

